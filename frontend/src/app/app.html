@if (!isAuthenticated) {
  <app-login></app-login>
} @else {
  <div class="main-container" (click)="closeProfileDropdown()">
    <aside class="sidebar" [class.collapsed]="sidebarCollapsed">
      <!-- Sidebar Toggle Button -->
      <button class="sidebar-toggle" (click)="toggleSidebar()">
        <i class="fas" [ngClass]="sidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
      </button>
      
      <div class="logo-container" [class.collapsed]="sidebarCollapsed">
        <img src="/forza-logo.png" alt="Forza Logo" class="logo-full" *ngIf="!sidebarCollapsed">
        <img src="/forza-logo.png" alt="Forza Logo" class="logo-compact" *ngIf="sidebarCollapsed">
      </div>
      
      <nav class="main-nav">
        <ul>
          <li (click)="setFilter('getting-started')" [class.active]="currentFilter === 'getting-started'" title="Getting Started">
            <i class="nav-icon fas fa-rocket"></i>
            <span class="nav-text">Getting Started</span>
          </li>
          
          <li (click)="setFilter('Operations')" [class.active]="currentFilter === 'Operations'" title="Operations">
            <i class="nav-icon fas fa-cogs"></i>
            <span class="nav-text">Operations</span>
          </li>
          
          <li (click)="setFilter('Finance')" [class.active]="currentFilter === 'Finance'" title="Finance">
            <i class="nav-icon fas fa-chart-line"></i>
            <span class="nav-text">Finance</span>
          </li>
          
          <!-- Workshop with submenu -->
          <li class="has-submenu" [class.active]="currentFilter === 'Workshop'" [class.expanded]="workshopExpanded" title="Workshop">
            <div class="nav-item-container">
              <div class="nav-content" (click)="setFilter('Workshop')">
                <i class="nav-icon fas fa-wrench"></i>
                <span class="nav-text">Workshop</span>
              </div>
              <i class="submenu-arrow fas" [ngClass]="workshopExpanded ? 'fa-chevron-down' : 'fa-chevron-right'" *ngIf="!sidebarCollapsed" (click)="toggleWorkshopSubmenu(); $event.stopPropagation()"></i>
            </div>
            
            <ul class="submenu" *ngIf="workshopExpanded && !sidebarCollapsed">
              <li (click)="setFilter('Forza Transportation'); $event.stopPropagation()" [class.active]="currentFilter === 'Forza Transportation'">
                <span class="nav-text">Forza Transportation ðŸ‡ºðŸ‡¸</span>
              </li>
              <li (click)="setFilter('Force One Transport'); $event.stopPropagation()" [class.active]="currentFilter === 'Force One Transport'">
                <span class="nav-text">Force One Transport ðŸ‡²ðŸ‡½</span>
              </li>
            </ul>
          </li>
          
          <!-- Human Resources with submenu -->
          <li class="has-submenu" [class.active]="currentFilter === 'Human Resources'" [class.expanded]="hrExpanded" title="Human Resources">
            <div class="nav-item-container">
              <div class="nav-content" (click)="setFilter('Human Resources')">
                <i class="nav-icon fas fa-users"></i>
                <span class="nav-text">Human Resources</span>
              </div>
              <i class="submenu-arrow fas" [ngClass]="hrExpanded ? 'fa-chevron-down' : 'fa-chevron-right'" *ngIf="!sidebarCollapsed" (click)="toggleHRSubmenu(); $event.stopPropagation()"></i>
            </div>
            
            <ul class="submenu" *ngIf="hrExpanded && !sidebarCollapsed">
              <li (click)="setFilter('Employee Management'); $event.stopPropagation()" [class.active]="currentFilter === 'Employee Management'">
                <span class="nav-text">Employee Management</span>
              </li>
              <li (click)="setFilter('Payroll'); $event.stopPropagation()" [class.active]="currentFilter === 'Payroll'">
                <span class="nav-text">Payroll</span>
              </li>
              <li (click)="setFilter('Performance Reviews'); $event.stopPropagation()" [class.active]="currentFilter === 'Performance Reviews'">
                <span class="nav-text">Performance Reviews</span>
              </li>
              <li (click)="setFilter('Recruiting'); $event.stopPropagation()" [class.active]="currentFilter === 'Recruiting'">
                <span class="nav-text">Recruiting</span>
              </li>
              <li (click)="setFilter('Training'); $event.stopPropagation()" [class.active]="currentFilter === 'Training'">
                <span class="nav-text">Training</span>
              </li>
            </ul>
          </li>
          
          <!-- Tires with submenu -->
          <li class="has-submenu" [class.active]="currentFilter === 'Tires'" [class.expanded]="llantasExpanded" title="Tires">
            <div class="nav-item-container">
              <div class="nav-content" (click)="setFilter('Tires')">
                <i class="nav-icon fas fa-circle"></i>
                <span class="nav-text">Tires</span>
              </div>
              <i class="submenu-arrow fas" [ngClass]="llantasExpanded ? 'fa-chevron-down' : 'fa-chevron-right'" *ngIf="!sidebarCollapsed" (click)="toggleLlantasSubmenu(); $event.stopPropagation()"></i>
            </div>
            
            <ul class="submenu" *ngIf="llantasExpanded && !sidebarCollapsed">
              <li (click)="setFilter('Alignments'); $event.stopPropagation()" [class.active]="currentFilter === 'Alignments'">
                <span class="nav-text">Alignments</span>
              </li>
            </ul>
          </li>
          
          <li (click)="setFilter('Executive & Management')" [class.active]="currentFilter === 'Executive & Management'" title="Executive & Management">
            <i class="nav-icon fas fa-user-tie"></i>
            <span class="nav-text">Executive & Management</span>
          </li>
        </ul>
      </nav>
      <div class="add-button-container">
        @if (isAdmin) {
          <button (click)="showAddModal = true">Add Dashboard</button>
        }
      </div>
    </aside>
    <main class="content">
      <header class="content-header">
        @if (currentFilter === 'getting-started') {
          <h1>Getting Started</h1>
        } @else if (currentFilter === 'Forza Transportation') {
          <h1>Forza Transportation Dashboards ðŸ‡ºðŸ‡¸</h1>
        } @else if (currentFilter === 'Force One Transport') {
          <h1>Force One Transport Dashboards ðŸ‡²ðŸ‡½</h1>
        } @else {
          <h1>{{ currentFilter }}</h1>
        }
        <div class="header-actions">
          <button class="request-dashboard-btn" (click)="showRequestModal = true">
            Request New Dashboard 
          </button>
          <div class="profile-dropdown" (click)="toggleProfileDropdown(); $event.stopPropagation()">
            <div class="profile-avatar">
              <span class="avatar-text">{{ getUserInitials() }}</span>
            </div>
            <div class="profile-dropdown-content" [class.show]="showProfileDropdown" (click)="$event.stopPropagation()">
              <div class="profile-info">
                <div class="profile-avatar-large">
                  <span class="avatar-text-large">{{ getUserInitials() }}</span>
                </div>
                <div class="profile-details">
                  <div class="profile-name">
                    {{ (currentUser?.first_name && currentUser?.last_name) 
                       ? (currentUser.first_name + ' ' + currentUser.last_name) 
                       : (currentUser?.username || 'User') }}
                  </div>
                  <div class="profile-email">{{ currentUser?.email || 'user@company.com' }}</div>
                  <div class="profile-role">
                    {{ currentUser?.position || (isAdmin ? 'Administrator' : 'User') }}
                    @if (currentUser?.department) {
                      <span class="department-badge">{{ currentUser.department }}</span>
                    }
                  </div>
                </div>
              </div>
              
              <hr class="dropdown-divider">
              
              <button class="dropdown-item" (click)="$event.stopPropagation()">
                <i class="fas fa-user profile-icon"></i>
                My Profile
              </button>
              
              <button class="dropdown-item" (click)="$event.stopPropagation()">
                <i class="fas fa-cog profile-icon"></i>
                Settings
              </button>
              
              <button class="dropdown-item" (click)="$event.stopPropagation()">
                <i class="fas fa-question-circle profile-icon"></i>
                Help & Support
              </button>
              
              <hr class="dropdown-divider">
              
              <button class="dropdown-item logout-item" (click)="logout(); $event.stopPropagation()">
                <i class="fas fa-sign-out-alt logout-icon"></i>
                Logout
              </button>
            </div>
          </div>
        </div>
      </header>
      @if (currentFilter === 'getting-started') {
        <div class="getting-started-content">
          <div class="welcome-section">
            <h2>Welcome to the Business Intelligence Dashboard Portal</h2>
            <p>Your central hub for all business intelligence and analytics across Forza Transportation Services.</p>
          </div>
          
          <div class="bi-team-section">
            <div class="section-header" (click)="toggleBiTeam()">
              <h2>Meet Your BI Team</h2>
              <button class="expand-btn" [class.expanded]="biTeamExpanded">
                <i class="expand-icon" [ngClass]="biTeamExpanded ? 'fas fa-minus' : 'fas fa-plus'"></i>
                <span class="expand-text">{{ biTeamExpanded ? 'Hide' : 'Show' }} Team</span>
              </button>
            </div>
            <p>Our dedicated Business Intelligence team is here to help you make data-driven decisions. Contact us for dashboard requests, training, or analytics support.</p>
            
            <div class="team-cards" *ngIf="biTeamExpanded">
              <div class="team-card">
                <a href="https://wa.me/5218120729613?text=Hola%20Martin,%20tengo%20una%20consulta%20sobre%20Business%20Intelligence" 
                   class="whatsapp-icon" target="_blank" rel="noopener noreferrer" title="Contactar a Martin por WhatsApp">
                  <i class="fab fa-whatsapp"></i>
                </a>
                <div class="team-photo">
                  <img src="/Martin.jpg" alt="Martin Alejandro Martinez Rodea" />
                </div>
                <h3>Martin Alejandro Martinez Rodea</h3>
                <p class="role">BI Team Lead - Mexico</p>
                <p class="email">marmartinez&#64;forzatrans.com</p>
                <p class="description">Leading business intelligence initiatives and dashboard strategy</p>
              </div>
              
              <div class="team-card">
                <a href="https://wa.me/5218111066532?text=Hola%20Alan,%20tengo%20una%20consulta%20sobre%20Business%20Intelligence" 
                   class="whatsapp-icon" target="_blank" rel="noopener noreferrer" title="Contactar a Alan por WhatsApp">
                  <i class="fab fa-whatsapp"></i>
                </a>
                <div class="team-photo">
                  <img src="/Alan.jpg" alt="Alan Saucedo Rodriguez" />
                </div>
                <h3>Alan Saucedo Rodriguez</h3>
                <p class="role">BI Senior Analyst - Mexico</p>
                <p class="email">alan.saucedo&#64;forzatrans.com</p>
                <p class="description">Equipment control dashboards and yard operations analytics specialist</p>
              </div>
              
              <div class="team-card">
                <a href="https://wa.me/5218111055740?text=Hola%20Andrea,%20tengo%20una%20consulta%20sobre%20Business%20Intelligence" 
                   class="whatsapp-icon" target="_blank" rel="noopener noreferrer" title="Contactar a Andrea por WhatsApp">
                  <i class="fab fa-whatsapp"></i>
                </a>
                <div class="team-photo">
                  <img src="/Andrea.png" alt="Andrea Sofia Lopez" />
                </div>
                <h3>Andrea Sofia Lopez</h3>
                <p class="role">BI Senior Analyst - Mexico</p>
                <p class="email">andrea.lopez&#64;forzatrans.com</p>
                <p class="description">Human Resources analytics and HR dashboard development specialist</p>
              </div>
              
              <div class="team-card">
                <a href="https://wa.me/5218111530308?text=Hola%20Andres,%20tengo%20una%20consulta%20sobre%20Business%20Intelligence" 
                   class="whatsapp-icon" target="_blank" rel="noopener noreferrer" title="Contactar a Andres por WhatsApp">
                  <i class="fab fa-whatsapp"></i>
                </a>
                <div class="team-photo">
                  <img src="/Andres.jpg" alt="Andres Huguet Mack" />
                </div>
                <h3>Andres Huguet Mack</h3>
                <p class="role">BI Senior Analyst - Mexico</p>
                <p class="email">andres.huguet&#64;forzatrans.com</p>
                <p class="description">Operations analytics and transportation performance dashboard specialist</p>
              </div>
              
              <div class="team-card">
                <a href="https://wa.me/5218114201718?text=Hola%20Angel,%20tengo%20una%20consulta%20sobre%20Business%20Intelligence" 
                   class="whatsapp-icon" target="_blank" rel="noopener noreferrer" title="Contactar a Angel por WhatsApp">
                  <i class="fab fa-whatsapp"></i>
                </a>
                <div class="team-photo">
                  <img src="/Miguel-Angel.jpg" alt="Miguel Angel Loera Guerrero" />
                </div>
                <h3>Miguel Angel Loera Guerrero</h3>
                <p class="role">BI Senior Analyst - Mexico</p>
                <p class="email">miguel.loera&#64;forzatrans.com</p>
                <p class="description">Workshop analytics and maintenance dashboard development specialist</p>
              </div>
            </div>
          </div>
          
          <div class="stats-section">
            <div class="section-header" (click)="toggleSystemOverview()">
              <h2>System Overview</h2>
              <i class="fas" [ngClass]="systemOverviewExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            </div>
            <p>Real-time statistics and performance metrics for the Forza Transportation Services BI Portal. Monitor active dashboards, user engagement, and system health.</p>
            @if (systemOverviewExpanded) {
              <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-chart-bar"></i></div>
                <div class="stat-number">{{ totalDashboards || 0 }}</div>
                <div class="stat-label">Active Dashboards</div>
                <div class="stat-sublabel">Across all departments</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-building"></i></div>
                <div class="stat-number">{{ departments || 0 }}</div>
                <div class="stat-label">Departments</div>
                <div class="stat-sublabel">Operations, Finance, Workshop</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-number">{{ activeUsers || 0 }}</div>
                <div class="stat-label">Active Users</div>
                <div class="stat-sublabel">Currently registered</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                <div class="stat-number">{{ recentUpdates?.length || 0 }}</div>
                <div class="stat-label">Recent Updates</div>
                <div class="stat-sublabel">Last 30 days</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-user-tie"></i></div>
                <div class="stat-number">5</div>
                <div class="stat-label">BI Team Members</div>
                <div class="stat-sublabel">Available for support</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-database"></i></div>
                <div class="stat-number">SQLite</div>
                <div class="stat-label">Database Type</div>
                <div class="stat-sublabel">Optimized performance</div>
              </div>
              </div>
            }
          </div>
          
          <div class="recent-updates-section">
            <div class="section-header" (click)="toggleRecentUpdates()">
              <h2>Recent Updates</h2>
              <i class="fas" [ngClass]="recentUpdatesExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            </div>
            <p>Stay informed about the latest dashboard additions and updates across all departments. Track new features and improvements to existing analytics.</p>
            @if (recentUpdatesExpanded) {
              <div class="updates-list">
              @if (recentUpdates.length > 0) {
                @for (update of recentUpdates; track update.titulo) {
                  <div class="update-item">
                    <div class="update-date">{{ update.created_date | date:'MMM d, y' }}</div>
                    <div class="update-content">{{ update.titulo }} added to {{ update.categoria }} department</div>
                  </div>
                }
              } @else {
                <div class="update-item">
                  <div class="update-date">-</div>
                  <div class="update-content">No recent updates available</div>
                </div>
              }
              </div>
            }
          </div>
          
          <div class="featured-dashboards-section">
            <div class="section-header" (click)="toggleFeaturedDashboards()">
              <h2>Featured Dashboards</h2>
              <i class="fas" [ngClass]="featuredDashboardsExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            </div>
            <p>Explore our most popular and impactful dashboards. These featured analytics provide key insights for strategic decision-making across all business units.</p>
            @if (featuredDashboardsExpanded) {
              <div class="featured-grid">
              @if (featuredDashboards.length > 0) {
                @for (dashboard of featuredDashboards; track dashboard.id) {
                  <div class="featured-item">
                    <div class="featured-category">{{ dashboard.categoria }}</div>
                    <div class="featured-title">{{ dashboard.titulo }}</div>
                    <div class="featured-description">{{ dashboard.descripcion || 'Dashboard for ' + dashboard.categoria + ' department' }}</div>
                  </div>
                }
              } @else {
                <div class="featured-item">
                  <div class="featured-category">System</div>
                  <div class="featured-title">No Featured Dashboards</div>
                  <div class="featured-description">Add dashboards to see featured content here</div>
                </div>
              }
              </div>
            }
          </div>
          
          <div class="training-resources-section">
            <div class="section-header" (click)="toggleTrainingResources()">
              <h2>Training Resources</h2>
              <i class="fas" [ngClass]="trainingResourcesExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            </div>
            <p>Access comprehensive training materials to maximize your use of our BI platform. From basic navigation to advanced analytics techniques and best practices.</p>
            @if (trainingResourcesExpanded) {
              <div class="resources-grid">
              <div class="resource-item">
                <div class="resource-icon"><i class="fas fa-chart-bar"></i></div>
                <div class="resource-content">
                  <h3>Power BI Basics</h3>
                  <p>Learn the fundamentals of Power BI dashboard navigation</p>
                  <a href="#" class="resource-link">View Tutorial</a>
                </div>
              </div>
              <div class="resource-item">
                <div class="resource-icon"><i class="fas fa-chart-line"></i></div>
                <div class="resource-content">
                  <h3>Data Analysis Guide</h3>
                  <p>Understanding charts, filters, and data interpretation</p>
                  <a href="#" class="resource-link">Download Guide</a>
                </div>
              </div>
              <div class="resource-item">
                <div class="resource-icon"><i class="fas fa-video"></i></div>
                <div class="resource-content">
                  <h3>Video Tutorials</h3>
                  <p>Step-by-step video guides for common dashboard tasks</p>
                  <a href="#" class="resource-link">Watch Videos</a>
                </div>
              </div>
              <div class="resource-item">
                <div class="resource-icon"><i class="fas fa-clipboard-list"></i></div>
                <div class="resource-content">
                  <h3>Best Practices</h3>
                  <p>Tips for effective dashboard usage and data insights</p>
                  <a href="#" class="resource-link">Read More</a>
                </div>
              </div>
              </div>
            }
          </div>
          
          <div class="quick-start-section">
            <div class="section-header" (click)="toggleQuickStartGuide()">
              <h2>Quick Start Guide</h2>
              <i class="fas" [ngClass]="quickStartGuideExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            </div>
            <p>Get up and running quickly with our BI platform. Follow these simple steps to navigate dashboards, access reports, and request custom analytics.</p>
            @if (quickStartGuideExpanded) {
              <div class="guide-steps">
              <div class="step">
                <h3>1. Navigate Departments</h3>
                <p>Use the sidebar to browse dashboards by department (Operations, Finance, Workshop, etc.)</p>
              </div>
              <div class="step">
                <h3>2. View Dashboards</h3>
                <p>Click on any dashboard card to open it in a new tab</p>
              </div>
              <div class="step">
                <h3>3. Request New Dashboards</h3>
                <p>Use the request form above to submit custom dashboard requirements</p>
              </div>
              </div>
            }
          </div>
        </div>
      } @else {
        @if (currentFilter === 'Forza Transportation') {
          <div class="category-description">
            <p>Analytics and reports for US operations</p>
          </div>
        } @else if (currentFilter === 'Force One Transport') {
          <div class="category-description">
            <p>Analytics and reports for Mexico operations</p>
          </div>
        }
        <div class="gallery">
          @for (board of filteredDashboards; track board.id) {
            <app-dashboard-card 
              [dashboard]="board"
              (editDashboard)="onEditDashboard($event)"
              (deleteDashboard)="onDeleteDashboard($event)">
            </app-dashboard-card>
          }
        </div>
      }
    </main>
  </div>
  
  <!-- Request Dashboard Modal -->
  @if (showRequestModal) {
    <div class="modal-overlay" (click)="onRequestModalOverlayClick($event)">
      <div class="modal-content request-dashboard-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Request New Dashboard</h2>
          <button class="close-btn" (click)="showRequestModal = false">Ã—</button>
        </div>
        
        <div class="modal-body">
          <div class="form-container-request">
            <form>
              <input 
                type="text" 
                id="dash-name" 
                placeholder="Dashboard Name *"
                required>
              
              <select id="dept-select" required>
                <option value="">Select Department *</option>
                <option value="Operations">Operations</option>
                <option value="Finance">Finance</option>
                <option value="Workshop">Workshop</option>
                <option value="Human Resources">Human Resources</option>
                <option value="Tires">Tires</option>
                <option value="Executive & Management">Executive & Management</option>
              </select>
              
              <textarea 
                id="requirements-text" 
                placeholder="Dashboard Requirements & Description *
â€¢ Key metrics and KPIs to track
â€¢ Data sources needed
â€¢ Visualizations required
â€¢ Target audience
â€¢ Integration needs"
                rows="6"
                required></textarea>
              
              <select id="priority-level" required>
                <option value="standard">Standard Priority (2-3 weeks)</option>
                <option value="high">High Priority (1-2 weeks)</option>
                <option value="urgent">Urgent (< 1 week)</option>
              </select>
              
              <div class="form-buttons">
                <button type="button" class="whatsapp-btn" (click)="submitDashboardRequest()">
                  <i class="fab fa-whatsapp"></i>
                  Send to WhatsApp
                </button>
                <button type="button" class="cancel-btn" (click)="showRequestModal = false">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  }
  
  <!-- Add Dashboard Modal -->
  @if (showAddModal && isAdmin) {
    <div class="modal-overlay" (click)="onModalOverlayClick($event)">
      <div class="modal-content add-dashboard-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>+ Add New Dashboard</h2>
          <button class="close-btn" (click)="showAddModal = false">Ã—</button>
        </div>
        
        <div class="modal-body">
          <app-add-dashboard-form 
            [dashboardToEdit]="dashboardToEdit"
            (dashboardAdded)="onDashboardAdded()"
            (cancelled)="onDashboardFormCancelled()">
          </app-add-dashboard-form>
        </div>
      </div>
    </div>
  }
  
  <!-- Confirm Delete Modal -->
  @if (showConfirmModal) {
    <div class="modal-overlay" (click)="cancelDelete()">
      <div class="modal-content confirm-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ confirmModalData.title }}</h2>
          <button class="close-btn" (click)="cancelDelete()">Ã—</button>
        </div>
        
        <div class="modal-body">
          <div class="confirm-content">
            <p class="confirm-message">{{ confirmModalData.message }}</p>
            <p class="confirm-warning">Esta acciÃ³n no se puede deshacer.</p>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="cancel-btn" (click)="cancelDelete()">Cancelar</button>
          <button class="delete-btn confirm-delete-btn" (click)="confirmDelete()">Eliminar</button>
        </div>
      </div>
    </div>
  }
}